<!doctype html>
<html lang="de">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Leo To-Do Listen</title>
    <style>
        :root {
            --bg: #0f172a;
            --card: #1f2937;
            --muted: #9ca3af;
            --text: #e5e7eb;
            --accent: #60a5fa;
            --accent-2: #34d399;
            --yellow: #fbbf24;
            --shadow: 0 10px 30px rgba(0,0,0,.35);
            --radius: 18px
        }

        * {
            box-sizing: border-box
        }

        body {
            margin: 0;
            font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
            background: var(--bg);
            color: var(--text)
        }

        /* Header */
        header {
            position: sticky;
            top: 0;
            z-index: 5;
            backdrop-filter: blur(8px);
            background: rgba(15,23,42,.7);
            border-bottom: 1px solid rgba(255,255,255,.06)
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px
        }

        h1 {
            margin: 0;
            font-size: 28px;
            display: flex;
            align-items: center;
            gap: 10px
        }

        #app-title[contenteditable="true"] {
            outline: none;
            border-bottom: 1px dashed transparent
        }

            #app-title[contenteditable="true"]:focus {
                border-bottom: 1px dashed rgba(255,255,255,.35)
            }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 8px
        }

        .icon-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 36px;
            height: 36px;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,.12);
            background: var(--card);
            color: var(--text);
            cursor: pointer;
            font-size: 18px;
            line-height: 1
        }

            .icon-btn.active {
                background: linear-gradient(180deg,var(--accent),#3b82f6);
                border-color: transparent;
                color: #061527;
            }

            .icon-btn[disabled] {
                opacity: .45;
                cursor: not-allowed
            }

        /* Board */
        .grid {
            display: grid;
            gap: 16px;
            grid-template-columns: repeat(4,1fr);
            padding: 20px
        }

        @media (max-width:1100px) {
            .grid {
                grid-template-columns: repeat(2,1fr)
            }
        }

        @media (max-width:650px) {
            .grid {
                grid-template-columns: 1fr
            }
        }

        .column {
            background: rgba(255,255,255,.05);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            min-height: 220px
        }

        .col-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-weight: 700;
            padding: 12px 14px;
            border-bottom: 1px solid rgba(255,255,255,.08)
        }

        .badge {
            font-size: 12px;
            color: #061527;
            background: var(--yellow);
            padding: 2px 8px;
            border-radius: 999px
        }

        .quick-add {
            display: flex;
            gap: 8px;
            padding: 10px;
            border-bottom: 1px dashed rgba(255,255,255,.08)
        }

            .quick-add input {
                flex: 1;
                background: var(--card);
                border: 1px solid rgba(255,255,255,.1);
                border-radius: 10px;
                padding: 8px 10px;
                color: var(--text)
            }

            .quick-add button {
                border: none;
                border-radius: 10px;
                padding: 8px 10px;
                font-weight: 600;
                cursor: pointer;
                color: #061527;
                background: linear-gradient(180deg,var(--accent),#3b82f6)
            }

        .tasks {
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-height: 40px;
            padding: 10px
        }

        .task {
            background: var(--card);
            padding: 10px 12px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: grab;
            border: 1px solid rgba(255,255,255,.1)
        }

            .task.dragging {
                opacity: .6
            }

        .title {
            flex: 1
        }

        .due {
            font-size: 12px;
            color: var(--muted);
            margin-left: 6px
        }

        /* Panels */
        .panel {
            margin: 0 20px 30px;
            border-radius: var(--radius);
            border: 1px solid rgba(255,255,255,.12);
            background: rgba(255,255,255,.03)
        }

        .panel-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 14px;
            cursor: pointer;
            user-select: none
        }

        .panel-actions {
            display: flex;
            align-items: center;
            gap: 8px
        }

        .panel-toggle {
            position: relative;
            width: 38px;
            height: 28px;
            border: none;
            border-radius: 999px;
            cursor: pointer;
            background: var(--yellow);
            color: #061527
        }

            .panel-toggle::before {
                content: '▸';
                display: block;
                font-weight: 900;
                line-height: 28px;
                text-align: center
            }

        .panel.open .panel-toggle::before {
            content: '▾'
        }

        .panel-body {
            display: none;
            padding: 14px;
            border-top: 1px solid rgba(255,255,255,.08)
        }

        .panel.open .panel-body {
            display: block
        }

        .rec-list {
            display: grid;
            gap: 8px;
            margin-top: 10px
        }

        .rec-item {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--card);
            border: 1px solid rgba(255,255,255,.08);
            padding: 8px 10px;
            border-radius: 10px
        }

        .muted {
            color: var(--muted);
            font-size: 12px
        }

        .row {
            display: flex;
            gap: 8px;
            flex-wrap: wrap
        }

            .row > * {
                flex: 1
            }

        .btn {
            border: none;
            border-radius: 10px;
            padding: 8px 10px;
            font-weight: 600;
            cursor: pointer;
            color: #061527;
            background: linear-gradient(180deg,var(--accent),#3b82f6)
        }

            .btn.secondary {
                background: linear-gradient(180deg,#6ee7b7,var(--accent-2))
            }

        /* Vorlagen Eingaben */
        .input-dark, .select-dark {
            background: var(--card);
            border: 1px solid rgba(255,255,255,.1);
            color: var(--text);
            border-radius: 10px;
            padding: 8px 10px;
            height: 38px
        }

        .weekday-group {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            align-items: center
        }

        .wbtn {
            background: transparent;
            border: 1px solid rgba(255,255,255,.18);
            color: var(--text);
            padding: 6px 10px;
            border-radius: 999px;
            cursor: pointer;
            font-weight: 600
        }

            .wbtn.active {
                background: linear-gradient(180deg,var(--accent),#3b82f6);
                color: #061527;
                border-color: transparent
            }

            .wbtn.disabled {
                opacity: .5;
                pointer-events: none
            }

        /* Shopping */
        .shop-grid {
            display: grid;
            grid-template-columns: 1.2fr .8fr;
            gap: 16px
        }

        @media (max-width:900px) {
            .shop-grid {
                grid-template-columns: 1fr
            }
        }

        .shop-list-box, .shop-palette-box {
            background: rgba(255,255,255,.03);
            border: 1px solid rgba(255,255,255,.08);
            border-radius: 12px;
            padding: 10px
        }

        .shop-quick {
            display: flex;
            gap: 8px;
            margin-bottom: 8px
        }

            .shop-quick input {
                flex: 1;
                background: var(--card);
                border: 1px solid rgba(255,255,255,.1);
                border-radius: 10px;
                padding: 8px 10px;
                color: var(--text)
            }

            .shop-quick button {
                border: none;
                border-radius: 10px;
                padding: 8px 10px;
                font-weight: 600;
                cursor: pointer;
                color: #061527;
                background: linear-gradient(180deg,var(--accent),#3b82f6)
            }

        .shop-items {
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-height: 40px
        }

        .shop-item {
            background: var(--card);
            border: 1px solid rgba(255,255,255,.1);
            border-radius: 10px;
            padding: 8px 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: grab
        }

            .shop-item.dragging {
                opacity: .6
            }

        .shop-title {
            flex: 1
        }

        .palette {
            display: flex;
            flex-wrap: wrap;
            gap: 8px
        }

        .chip {
            display: flex;
            align-items: center;
            gap: 6px;
            border: 1px solid rgba(255,255,255,.15);
            background: transparent;
            color: var(--text);
            padding: 6px 10px;
            border-radius: 999px
        }

            .chip button {
                cursor: pointer;
                border: none;
                background: transparent
            }

            .chip .del {
                color: var(--muted)
            }

            .chip.dragging {
                opacity: .6
            }

        /* Notes panel */
        .notes-grid {
            display: grid;
            gap: 16px;
            grid-template-columns: repeat(4,1fr)
        }

        @media (max-width:1100px) {
            .notes-grid {
                grid-template-columns: repeat(2,1fr)
            }
        }

        @media (max-width:650px) {
            .notes-grid {
                grid-template-columns: 1fr
            }
        }

        .note-column {
            background: rgba(255,255,255,.05);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            min-height: 160px
        }

        .note-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-weight: 700;
            padding: 12px 14px;
            border-bottom: 1px solid rgba(255,255,255,.08)
        }

        .note-title[contenteditable="true"] {
            outline: none;
            border-bottom: 1px dashed transparent
        }

            .note-title[contenteditable="true"]:focus {
                border-bottom: 1px dashed rgba(255,255,255,.35)
            }

        .notes-quick {
            display: flex;
            gap: 8px;
            padding: 10px;
            border-bottom: 1px dashed rgba(255,255,255,.08)
        }

            .notes-quick input {
                flex: 1;
                background: var(--card);
                border: 1px solid rgba(255,255,255,.1);
                border-radius: 10px;
                padding: 8px 10px;
                color: var(--text)
            }

            .notes-quick button {
                border: none;
                border-radius: 10px;
                padding: 8px 10px;
                font-weight: 600;
                cursor: pointer;
                color: #061527;
                background: linear-gradient(180deg,var(--accent),#3b82f6)
            }

        .notes-items {
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-height: 40px;
            padding: 10px
        }

        .note-item {
            background: var(--card);
            padding: 10px 12px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: grab;
            border: 1px solid rgba(255,255,255,.1)
        }

            .note-item.dragging {
                opacity: .6
            }

        .note-text {
            flex: 1
        }

        .note-toggle {
            width: 28px;
            height: 24px;
            border: none;
            border-radius: 999px;
            background: rgba(255,255,255,.12);
            color: #061527;
            cursor: pointer
        }

            .note-toggle::before {
                content: '▸';
                display: block;
                line-height: 24px;
                text-align: center
            }

        .note-col.open .note-toggle::before {
            content: '▾'
        }

        .note-col-body {
            display: block
        }

        .note-col.closed .note-col-body {
            display: none
        }
        /* Neu: Bei geschlossener Notizspalte wirklich nur Kopf anzeigen */
        .note-col.closed {
            min-height: auto
        }

        /* Einkaufsmodus: nur Einkaufsliste zeigen (ohne Schnellauswahl) */
        body.shop-only .grid,
        body.shop-only #rec-panel,
        body.shop-only #notes-panel {
            display: none !important
        }

        body.shop-only #shop-panel {
            display: block
        }

        body.shop-only .shop-grid {
            grid-template-columns: 1fr
        }

        body.shop-only .shop-palette-box {
            display: none !important
        }

        body.shop-only #toggle-shop-only {
            background: linear-gradient(180deg,#6ee7b7,var(--accent-2))
        }

        /* Entfernen-Animation */
        @keyframes bye {
            0% {
                opacity: 1;
                transform: translateY(0);
                background: #7f1d1d;
                border-color: #ef4444
            }

            60% {
                opacity: .6;
                transform: translateY(-6px);
                background: #7f1d1d;
            }

            100% {
                opacity: 0;
                transform: translateY(-10px);
            }
        }

        .flash-remove {
            animation: bye .28s ease-in forwards
        }

        /* iOS-Zoom verhindern */
        input, select, textarea {
            font-size: 16px
        }

        .quick-add input, .shop-quick input, .notes-quick input {
            font-size: 16px
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <!-- 1) Überschrift bearbeitbar -->
            <h1 id="app-title" contenteditable="true" title="Titel bearbeiten">🗂️ Leo To-Do Listen</h1>
            <div class="header-actions">
                <button id="undo-top-btn" class="icon-btn" title="Rückgängig (zuletzt entfernt)" disabled aria-label="Rückgängig">↩️</button>
            </div>
        </div>
    </header>

    <div class="grid">
        <div class="column" data-col="today">
            <div class="col-head"><span>Heute</span><span class="badge" id="count-today">0</span></div>
            <div class="quick-add"><input placeholder="Schnell hinzufügen…"><button>＋</button></div>
            <div class="tasks" id="tasks-today"></div>
        </div>
        <div class="column" data-col="tomorrow">
            <div class="col-head"><span>Morgen</span><span class="badge" id="count-tomorrow">0</span></div>
            <div class="quick-add"><input placeholder="Schnell hinzufügen…"><button>＋</button></div>
            <div class="tasks" id="tasks-tomorrow"></div>
        </div>
        <div class="column" data-col="soon">
            <div class="col-head"><span>Bald</span><span class="badge" id="count-soon">0</span></div>
            <!-- 2) Hinweis (optional Datum …) entfernt -->
            <div class="quick-add"><input placeholder="Schnell hinzufügen…"><button>＋</button></div>
            <div class="tasks" id="tasks-soon"></div>
        </div>
        <div class="column" data-col="general">
            <div class="col-head"><span>Allgemein</span><span class="badge" id="count-general">0</span></div>
            <div class="quick-add"><input placeholder="Schnell hinzufügen…"><button>＋</button></div>
            <div class="tasks" id="tasks-general"></div>
        </div>
    </div>

    <section class="panel" id="rec-panel">
        <div class="panel-head" id="rec-toggle">
            <h3 style="margin:0">🔁 Wiederholende Aufgaben</h3>
            <button class="panel-toggle" id="rec-toggle-btn" aria-label="Panel umschalten"></button>
        </div>
        <div class="panel-body" id="rec-body">
            <div class="row" id="rec-controls">
                <!-- 3) Beispieltext entfernt -->
                <input id="rec-title" class="input-dark" placeholder="Titel der Aufgabe" />
                <select id="rec-freq" class="select-dark">
                    <option value="daily">Täglich</option>
                    <option value="weekly">Wöchentlich</option>
                </select>
                <div id="rec-days" class="weekday-group" aria-label="Wochentage wählen">
                    <button type="button" class="wbtn" data-day="1">Mo</button>
                    <button type="button" class="wbtn" data-day="2">Di</button>
                    <button type="button" class="wbtn" data-day="3">Mi</button>
                    <button type="button" class="wbtn" data-day="4">Do</button>
                    <button type="button" class="wbtn" data-day="5">Fr</button>
                    <button type="button" class="wbtn" data-day="6">Sa</button>
                    <button type="button" class="wbtn" data-day="0">So</button>
                </div>
                <button class="btn" id="rec-add">＋ Aufgabe</button>
                <button class="btn secondary" id="rec-gen">↻ Jetzt erzeugen</button>
            </div>
            <div class="rec-list" id="recs"></div>
        </div>
    </section>

    <section class="panel" id="shop-panel">
        <div class="panel-head" id="shop-toggle">
            <h3 style="margin:0">🛒 Einkaufsliste</h3>
            <div class="panel-actions">
                <button class="btn" id="toggle-shop-only" title="Nur Einkaufsliste anzeigen">🛒 Einkaufsmodus</button>
                <button class="panel-toggle" id="shop-toggle-btn" aria-label="Panel umschalten"></button>
            </div>
        </div>
        <div class="panel-body" id="shop-body">
            <div class="shop-grid">
                <div class="shop-list-box">
                    <div class="shop-quick"><input id="shop-input" placeholder="Artikel hinzufügen…"><button id="shop-add">＋</button></div>
                    <div class="shop-items" id="shop-list"></div>
                </div>
                <div class="shop-palette-box">
                    <div class="muted" style="margin-bottom:8px">Schnellauswahl</div>
                    <div class="shop-quick"><input id="palette-input" placeholder="Neuer Favorit…"><button id="palette-add">＋</button></div>
                    <div class="palette" id="shop-palette"></div>
                </div>
            </div>
        </div>
    </section>

    <section class="panel" id="notes-panel">
        <div class="panel-head" id="notes-toggle">
            <h3 style="margin:0">🗒️ Notizboard</h3>
            <button class="panel-toggle" id="notes-toggle-btn" aria-label="Panel umschalten"></button>
        </div>
        <div class="panel-body" id="notes-body">
            <div class="notes-grid" id="notes-grid"></div>
        </div>
    </section>

    <script>
const $$ = s=>document.querySelector(s);
const $all = s=>Array.from(document.querySelectorAll(s));
const todayStr = ()=> new Date().toISOString().slice(0,10);
const tomorrowStr = ()=> { const d=new Date(); d.setDate(d.getDate()+1); return d.toISOString().slice(0,10) };
const weekday = d=> d.getDay();

const store={
  tasks:[], recs:[], lastGenDay:'', recsCollapsed:true, lastRollover:'',
  undoStack:[], shopItems:[], shopPalette:[], shopCollapsed:true,
  notes:{ cols:[], items:[], colStates:{} }, notesCollapsed:true,
  shopOnly:false, appTitle:'',
  load(){
    try{
      this.tasks=JSON.parse(localStorage.getItem('tasks_v9')||'[]');
      this.recs=JSON.parse(localStorage.getItem('recs_v9')||'[]');
      this.recsCollapsed=(localStorage.getItem('recsCollapsed_v4')||'true')==='true';
      this.lastGenDay=localStorage.getItem('lastGenDay_v4')||'';
      this.lastRollover=localStorage.getItem('lastRollover_v2')||'';
      this.undoStack=JSON.parse(localStorage.getItem('undo_v2')||'[]');
      this.shopItems=JSON.parse(localStorage.getItem('shop_items_v1')||'[]');
      this.shopPalette=JSON.parse(localStorage.getItem('shop_palette_v1')||'[]');
      this.shopCollapsed=(localStorage.getItem('shop_collapsed_v1')||'true')==='true';
      const savedNotes=JSON.parse(localStorage.getItem('notes_v1')||'{"cols":[],"items":[]}');
      this.notes = { cols: savedNotes.cols||[], items: savedNotes.items||[], colStates: savedNotes.colStates||{} };
      this.notesCollapsed=(localStorage.getItem('notes_collapsed_v1')||'true')==='true';
      this.shopOnly=(localStorage.getItem('shop_only_v1')||'false')==='true';
      this.appTitle = localStorage.getItem('app_title_v1') || '🗂️ Leo To-Do Listen';
      ensureNotesCols(8);
    }catch(e){
      this.tasks=[]; this.recs=[]; this.recsCollapsed=true; this.lastGenDay=''; this.lastRollover='';
      this.undoStack=[]; this.shopItems=[]; this.shopPalette=[]; this.shopCollapsed=true;
      this.notes={ cols:[], items:[], colStates:{} }; ensureNotesCols(8);
      this.notesCollapsed=true; this.shopOnly=false; this.appTitle='🗂️ Leo To-Do Listen';
    }
  },
  save(){
    localStorage.setItem('tasks_v9',JSON.stringify(this.tasks));
    localStorage.setItem('recs_v9',JSON.stringify(this.recs));
    localStorage.setItem('recsCollapsed_v4',String(this.recsCollapsed));
    localStorage.setItem('lastGenDay_v4',this.lastGenDay);
    localStorage.setItem('lastRollover_v2',this.lastRollover);
    localStorage.setItem('undo_v2',JSON.stringify(this.undoStack));
    localStorage.setItem('shop_items_v1', JSON.stringify(this.shopItems));
    localStorage.setItem('shop_palette_v1', JSON.stringify(this.shopPalette));
    localStorage.setItem('shop_collapsed_v1', String(this.shopCollapsed));
    localStorage.setItem('notes_v1', JSON.stringify(this.notes));
    localStorage.setItem('notes_collapsed_v1', String(this.notesCollapsed));
    localStorage.setItem('shop_only_v1', String(this.shopOnly));
    localStorage.setItem('app_title_v1', this.appTitle);
  }
};

const uid=()=>Date.now().toString(36)+Math.random().toString(36).slice(2,8);
function escapeHtml(s){ return String(s).replace(/[&<>\"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;'}[c])); }

/* Helpers */
function ensureNotesCols(n){
  if(!store.notes || !Array.isArray(store.notes.cols)) store.notes={cols:[],items:[],colStates:{}};
  const count = store.notes.cols.length;
  for(let i=count+1;i<=n;i++){
    const id=uid();
    store.notes.cols.push({id, title:'Notizen '+i});
    if(!store.notes.colStates) store.notes.colStates={};
    store.notes.colStates[id] = {collapsed:false};
  }
}

/* Tasks */
function addTask({title,column,dueAt=null,templateId=null,targetDate=null}){
  if(!title || !title.trim()) return;
  store.tasks.push({id:uid(),title:title.trim(),column,createdAt:Date.now(),dueAt,templateId,targetDate});
  store.save(); render();
}

function animateAndThen(el, fn){
  if(!el){ fn(); return; }
  el.classList.add('flash-remove');
  el.addEventListener('animationend', ()=> fn(), {once:true});
}

function taskNode(task){
  const el=document.createElement('div'); el.className='task'; el.draggable=true; el.dataset.id=task.id;
  el.innerHTML=`<input type="checkbox"> <div class="title">${escapeHtml(task.title)}</div> ${task.dueAt?`<span class='due'>(${task.dueAt})</span>`:''}`;
  const cb=el.querySelector('input');
  cb.addEventListener('change',()=>{
    cb.disabled=true;
    animateAndThen(el, ()=> removeTask(task.id));
  });
  el.addEventListener('dragstart',e=>{ el.classList.add('dragging'); e.dataTransfer.setData('text/plain',task.id); e.dataTransfer.effectAllowed='move'; });
  el.addEventListener('dragend',()=> el.classList.remove('dragging'));
  return el;
}

function removeTask(id){
  const idx = store.tasks.findIndex(t=>t.id===id);
  if(idx>-1){
    const [removed] = store.tasks.splice(idx,1);
    store.undoStack.push({kind:'task', item:removed});
    if(store.undoStack.length>5) store.undoStack.shift();
    store.save(); render();
  }
}

function undoRemove(){
  const entry=store.undoStack.pop();
  if(!entry) return;
  if(!entry.kind){ store.tasks.push(entry); }
  else if(entry.kind==='task'){ store.tasks.push(entry.item); }
  else if(entry.kind==='note'){ if(!store.notes.items.some(n=>n.id===entry.item.id)){ store.notes.items.push(entry.item); } }
  else if(entry.kind==='shop'){ store.shopItems.push(entry.item); }
  store.save(); render();
}

function updateUndoUI(){
  const btn=$$('#undo-top-btn');
  if(!btn) return;
  const hasUndo = store.undoStack.length>0;
  btn.disabled = !hasUndo;
  btn.classList.toggle('active', hasUndo);
}

/* DnD tasks */
function makeSortable(list,col){
  list.addEventListener('dragover',e=>{
    e.preventDefault();
    const after=getDragAfter(list,e.clientY);
    const dragging=document.querySelector('.task.dragging');
    if(!dragging) return;
    if(after==null) list.appendChild(dragging); else list.insertBefore(dragging,after);
  });
  list.addEventListener('drop',e=>{
    e.preventDefault();
    const ids=[...list.querySelectorAll('.task')].map(n=>n.dataset.id);
    ids.forEach(id=>{ const t=store.tasks.find(tt=>tt.id===id); if(t) t.column=col; });
    const colSet=new Set(ids);
    const others=store.tasks.filter(t=>t.column!==col || !colSet.has(t.id));
    const newCol=ids.map(id=>store.tasks.find(t=>t.id===id)).filter(Boolean);
    store.tasks=[...others,...newCol];
    store.save(); render();
  });
}
function getDragAfter(container,y){
  const els=[...container.querySelectorAll('.task:not(.dragging), .shop-item:not(.dragging), .note-item:not(.dragging)')];
  let closest=null; let closestOffset=Number.NEGATIVE_INFINITY;
  for(const el of els){
    const box=el.getBoundingClientRect(); const offset=y - box.top - box.height/2;
    if(offset<0 && offset>closestOffset){ closestOffset=offset; closest=el; }
  }
  return closest;
}

/* Render */
function render(){
  // 1) Header-Titel anzeigen
  const titleEl=$$('#app-title'); if(titleEl) titleEl.textContent = store.appTitle;

  ['today','tomorrow','soon','general'].forEach(col=>{
    const list=$$('#tasks-'+col); if(!list) return; list.innerHTML='';
    store.tasks.filter(t=>t.column===col).forEach(t=>list.appendChild(taskNode(t)));
    const b=$$('#count-'+col); if(b) b.textContent = store.tasks.filter(t=>t.column===col).length;
    makeSortable(list,col);
  });
  renderRecs();
  applyCollapseUI();
  renderShop();
  renderNotes();
  applyShopOnlyUI();
  updateUndoUI();
}

/* Quick add */
$all('.column').forEach(col=>{
  const qIn=col.querySelector('.quick-add input'); const qBtn=col.querySelector('.quick-add button'); const column=col.dataset.col;
  if(!qIn || !qBtn) return;
  const add=()=>{
    const title=(qIn.value||'').trim(); if(!title) return;
    let due=null;
    if(column==='soon'){
      const v=prompt('Optional: Fälligkeitsdatum (DD-MM-YYYY) oder leer','')||'';
      if(/^\d{2}-\d{2}-\d{4}$/.test(v)) due=v;
    }
    addTask({title,column,dueAt:due});
    qIn.value=''; qIn.focus();
  };
  qBtn.addEventListener('click', add);
  qIn.addEventListener('keydown',e=>{ if(e.key==='Enter') add(); });
});

/* Recurring */
function renderRecs(){
  const wrap=$$('#recs'); if(!wrap) return; wrap.innerHTML='';
  if(store.recs.length===0){ const p=document.createElement('p'); p.className='muted'; p.textContent='Noch keine Vorlagen.'; wrap.appendChild(p); return; }
  for(const r of store.recs){
    const tag = r.freq==='daily' ? 'täglich' : 'wöchentlich ('+(r.weekdays||[]).map(weekdayName).join(', ')+')';
    const el=document.createElement('div'); el.className='rec-item';
    el.innerHTML = `<div style="flex:1">${escapeHtml(r.title)} <span class="muted">• ${tag}</span></div><button class="btn" style="padding:6px 10px" title="Vorlage löschen">🗑️</button>`;
    const delBtn = el.querySelector('button');
    delBtn.addEventListener('click',()=>{ removeRec(r.id); });
    wrap.appendChild(el);
  }
}
function getSelectedWeekdays(){ return [...document.querySelectorAll('#rec-days .wbtn.active')].map(b=>Number(b.dataset.day)); }
function setDaysEnabled(enabled){ document.querySelectorAll('#rec-days .wbtn').forEach(b=> b.classList.toggle('disabled', !enabled)); }

function addRec({title,freq,weekdays=[]}){
  const rec={id:uid(),title:title.trim(),freq,weekdays};
  store.recs.push(rec);
  const todayKey = todayStr();
  const tomoKey  = tomorrowStr();
  if(rec.freq==='daily' || (rec.freq==='weekly' && (rec.weekdays||[]).map(Number).includes(new Date().getDay()))){
    maybeCreateInstance(rec, todayKey);
  }
  const wTomorrow = (new Date().getDay()+1)%7;
  if(rec.freq==='daily' || (rec.freq==='weekly' && (rec.weekdays||[]).map(Number).includes(wTomorrow))){
    maybeCreateInstance(rec, tomoKey);
  }
  store.save(); render(); return rec;
}
function removeRec(id){ store.recs=store.recs.filter(r=>r.id!==id); store.save(); renderRecs(); }
function weekdayName(n){ return ['So','Mo','Di','Mi','Do','Fr','Sa'][n]; }

function maybeCreateInstance(rec, targetDate){
  const exists = store.tasks.some(t=> t.templateId===rec.id && t.targetDate===targetDate);
  if(exists) return;
  const col = (targetDate===todayStr()) ? 'today' : (targetDate===tomorrowStr() ? 'tomorrow' : 'general');
  store.tasks.push({ id:uid(), title:rec.title, column:col, createdAt:Date.now(), templateId:rec.id, targetDate });
}
function generateRecurring(force=false){
  const today = new Date(); const todayKey=todayStr(); const tomoKey=tomorrowStr();
  if(force || store.lastGenDay!==todayKey){
    for(const r of store.recs){
      if(r.freq==='daily'){
        maybeCreateInstance(r, todayKey); maybeCreateInstance(r, tomoKey);
      } else if(r.freq==='weekly'){
        const w=weekday(today); const days=(r.weekdays||[]).map(Number);
        const wTomorrow = (w+1)%7;
        if(days.includes(w)) maybeCreateInstance(r, todayKey);
        if(days.includes(wTomorrow)) maybeCreateInstance(r, tomoKey);
      }
    }
    store.lastGenDay=todayKey; store.save();
  }
}

/* 00:01 Rollover */
function rolloverIfNeeded(force){
  const now = new Date(); const todayKey = todayStr();
  const minutes = now.getHours()*60 + now.getMinutes();
  const eligible = force || minutes >= 1;
  if(eligible && store.lastRollover !== todayKey){
    let moved = 0;
    for(const t of store.tasks){ if(t.column==='tomorrow'){ t.column='today'; moved++; } }
    if(moved>0){ store.save(); render(); }
    store.lastRollover = todayKey; store.save();
  }
}

/* Shopping */
function renderShop(){
  if(!Array.isArray(store.shopPalette) || store.shopPalette.length===0){
    store.shopPalette = ['Bananen','Äpfel','Milch','Eier','Brot','Butter','Käse','Tomaten','Gurken','Kartoffeln','Zwiebeln','Nudeln','Reis','Öl','Salz','Pfeffer','Joghurt','Müsli','Kaffee','Tee'];
    store.save();
  }
  const list=$$('#shop-list');
  if(list){
    list.innerHTML='';
    store.shopItems.forEach(it=> list.appendChild(shopItemNode(it)));
    makeSortableShop(list);
  }
  const pal=$$('#shop-palette');
  if(pal){
    pal.innerHTML='';
    store.shopPalette.forEach(name=> pal.appendChild(paletteChip(name)));
    makeSortablePalette(pal);
  }
  applyShopCollapseUI();
}
function shopItemNode(it){
  const el=document.createElement('div'); el.className='shop-item'; el.draggable=true; el.dataset.id=it.id;
  el.innerHTML=`<input type="checkbox"> <div class="shop-title">${escapeHtml(it.title)}</div>`;
  const cb=el.querySelector('input');
  cb.addEventListener('change', ()=>{
    cb.disabled=true;
    animateAndThen(el, ()=>{
      store.undoStack.push({kind:'shop', item:{...it}});
      store.shopItems = store.shopItems.filter(x=>x.id!==it.id);
      store.save(); renderShop(); updateUndoUI();
    });
  });
  el.addEventListener('dragstart',e=>{ el.classList.add('dragging'); e.dataTransfer.setData('text/plain',it.id); e.dataTransfer.effectAllowed='move'; });
  el.addEventListener('dragend',()=> el.classList.remove('dragging'));
  return el;
}
function addShopItem(title){ if(!title||!title.trim()) return; store.shopItems.push({id:uid(), title:title.trim(), createdAt:Date.now()}); store.save(); renderShop(); }
function makeSortableShop(list){
  list.addEventListener('dragover', e=>{
    e.preventDefault();
    const after=getDragAfter(list,e.clientY);
    const dragging=document.querySelector('.shop-item.dragging');
    if(!dragging) return;
    if(after==null) list.appendChild(dragging); else list.insertBefore(dragging, after);
  });
  list.addEventListener('drop', e=>{
    e.preventDefault();
    const ids=[...list.querySelectorAll('.shop-item')].map(n=>n.dataset.id);
    const ordered = ids.map(id=> store.shopItems.find(x=>x.id===id)).filter(Boolean);
    store.shopItems = ordered; store.save(); renderShop();
  });
}

/* Palette */
function paletteChip(name){
  const chip=document.createElement('div'); chip.className='chip'; chip.draggable=true; chip.dataset.name=name;
  const add=document.createElement('button'); add.textContent=name; add.title='Zur Liste hinzufügen';
  const del=document.createElement('button'); del.className='del'; del.textContent='✕'; del.title='Favorit entfernen';
  add.addEventListener('click',()=> addShopItem(name));
  del.addEventListener('click',()=>{ store.shopPalette = store.shopPalette.filter(n=>n!==name); store.save(); renderShop(); });
  chip.addEventListener('dragstart',e=>{ chip.classList.add('dragging'); e.dataTransfer.setData('text/plain', name); e.dataTransfer.effectAllowed='move'; });
  chip.addEventListener('dragend',()=> chip.classList.remove('dragging'));
  chip.appendChild(add); chip.appendChild(del); return chip;
}
function makeSortablePalette(container){
  function getAfter(y){
    const els=[...container.querySelectorAll('.chip:not(.dragging)')];
    let closest=null; let closestOffset=Number.NEGATIVE_INFINITY;
    for(const el of els){
      const box=el.getBoundingClientRect();
      const offset=y - box.top - box.height/2;
      if(offset<0 && offset>closestOffset){ closestOffset=offset; closest=el; }
    }
    return closest;
  }
  container.addEventListener('dragover',e=>{
    e.preventDefault();
    const dragging=document.querySelector('.chip.dragging'); if(!dragging) return;
    const after=getAfter(e.clientY);
    if(after==null) container.appendChild(dragging); else container.insertBefore(dragging, after);
  });
  container.addEventListener('drop',e=>{
    e.preventDefault();
    const names=[...container.querySelectorAll('.chip')].map(c=>c.dataset.name);
    store.shopPalette = names; store.save(); renderShop();
  });
}

/* Notes */
function renderNotes(){
  const grid=$$('#notes-grid'); if(!grid) return;
  grid.innerHTML='';
  for(const col of store.notes.cols){
    const colState = (store.notes.colStates && store.notes.colStates[col.id]) || {collapsed:false};
    const wrap=document.createElement('div');
    wrap.className='note-column note-col ' + (colState.collapsed ? 'closed' : 'open');
    wrap.dataset.col=col.id;
    wrap.innerHTML = `
      <div class="note-head">
        <span class="note-title" contenteditable="true" data-col="${col.id}" title="Titel bearbeiten">${escapeHtml(col.title)}</span>
        <div style="display:flex;align-items:center;gap:8px">
          <span class="badge">${store.notes.items.filter(i=>i.colId===col.id).length}</span>
          <button class="note-toggle" title="Spalte umschalten" aria-label="Spalte umschalten"></button>
        </div>
      </div>
      <div class="note-col-body">
        <div class="notes-quick">
          <input placeholder="Notiz hinzufügen…" data-col="${col.id}">
          <button data-col="${col.id}">＋</button>
        </div>
        <div class="notes-items" id="notes-items-${col.id}"></div>
      </div>
    `;
    grid.appendChild(wrap);

    const tbtn = wrap.querySelector('.note-toggle');
    tbtn.addEventListener('click', (e)=>{
      e.stopPropagation();
      const current = !!(store.notes.colStates && store.notes.colStates[col.id] && store.notes.colStates[col.id].collapsed);
      if(!store.notes.colStates) store.notes.colStates={};
      store.notes.colStates[col.id] = {collapsed: !current};
      store.save();
      renderNotes();
    });

    const list = wrap.querySelector('.notes-items');
    store.notes.items.filter(i=>i.colId===col.id).forEach(it=> list.appendChild(noteItemNode(it)) );
    makeSortableNotes(list, col.id);

    const inEl = wrap.querySelector('.notes-quick input');
    const btnEl = wrap.querySelector('.notes-quick button');
    const addNote = ()=>{
      const v=(inEl.value||'').trim(); if(!v) return;
      store.notes.items.push({id:uid(), colId:col.id, text:v, createdAt:Date.now()});
      store.save(); renderNotes();
      inEl.value=''; inEl.focus();
    };
    btnEl.addEventListener('click', addNote);
    inEl.addEventListener('keydown', e=>{ if(e.key==='Enter') addNote(); });

    const titleEl = wrap.querySelector('.note-title');
    titleEl.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); titleEl.blur(); } });
    titleEl.addEventListener('blur', ()=>{
      const t = titleEl.textContent.trim() || 'Unbenannt';
      const c = store.notes.cols.find(c=>c.id===col.id);
      if(c){ c.title = t; store.save(); }
    });
  }
}
function noteItemNode(it){
  const el=document.createElement('div'); el.className='note-item'; el.draggable=true; el.dataset.id=it.id;
  el.innerHTML = `<input type="checkbox"> <div class="note-text">${escapeHtml(it.text)}</div>`;
  const cb=el.querySelector('input');
  cb.addEventListener('change',()=>{
    cb.disabled=true;
    animateAndThen(el, ()=>{
      store.undoStack.push({kind:'note', item:{...it}});
      if(store.undoStack.length>5) store.undoStack.shift();
      store.notes.items = store.notes.items.filter(x=>x.id!==it.id);
      store.save(); renderNotes(); updateUndoUI();
    });
  });
  el.addEventListener('dragstart',e=>{ el.classList.add('dragging'); e.dataTransfer.setData('text/plain',it.id); e.dataTransfer.effectAllowed='move'; });
  el.addEventListener('dragend',()=> el.classList.remove('dragging'));
  return el;
}
function makeSortableNotes(list, colId){
  list.addEventListener('dragover', e=>{
    e.preventDefault();
    const after=getDragAfter(list,e.clientY);
    const dragging=document.querySelector('.note-item.dragging');
    if(!dragging) return;
    if(after==null) list.appendChild(dragging); else list.insertBefore(dragging, after);
  });
  list.addEventListener('drop', e=>{
    e.preventDefault();
    const ids=[...list.querySelectorAll('.note-item')].map(n=>n.dataset.id);
    ids.forEach(id=>{ const it=store.notes.items.find(x=>x.id===id); if(it) it.colId=colId; });
    const inCol = ids.map(id=> store.notes.items.find(x=>x.id===id)).filter(Boolean);
    const others = store.notes.items.filter(x=> x.colId!==colId || !ids.includes(x.id));
    store.notes.items = [...others, ...inCol];
    store.save(); renderNotes();
  });
}

/* Collapse UI */
function applyCollapseUI(){
  const panel=$$('#rec-panel'); const body=$$('#rec-body');
  if(store.recsCollapsed){ panel.classList.remove('open'); body.style.display='none'; }
  else { panel.classList.add('open'); body.style.display='block'; }
}
function toggleCollapse(){ store.recsCollapsed=!store.recsCollapsed; store.save(); applyCollapseUI(); }

function applyShopCollapseUI(){
  const panel=$$('#shop-panel'); const body=$$('#shop-body');
  if(store.shopCollapsed){ panel.classList.remove('open'); body.style.display='none'; }
  else { panel.classList.add('open'); body.style.display='block'; }
}
function toggleShopCollapse(){ store.shopCollapsed=!store.shopCollapsed; store.save(); applyShopCollapseUI(); }

function applyNotesCollapseUI(){
  const panel=$$('#notes-panel'); const body=$$('#notes-body');
  if(store.notesCollapsed){ panel.classList.remove('open'); body.style.display='none'; }
  else { panel.classList.add('open'); body.style.display='block'; }
}
function toggleNotesCollapse(){ store.notesCollapsed=!store.notesCollapsed; store.save(); applyNotesCollapseUI(); }

/* Shop-only */
function applyShopOnlyUI(){
  document.body.classList.toggle('shop-only', store.shopOnly);
  const btn=$$('#toggle-shop-only');
  if(btn) btn.textContent = store.shopOnly ? '↩️ Zurück' : '🛒 Einkaufsmodus';
  if(store.shopOnly){
    store.shopCollapsed=false; applyShopCollapseUI();
  }
}
function toggleShopOnly(){ store.shopOnly = !store.shopOnly; store.save(); applyShopOnlyUI(); }

/* Header-Title editing */
function wireAppTitle(){
  const el=$$('#app-title');
  if(!el) return;
  el.textContent = store.appTitle || '🗂️ Leo To-Do Listen';
  el.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); el.blur(); } });
  el.addEventListener('blur', ()=>{
    store.appTitle = el.textContent.trim() || '🗂️ Meine Liste';
    store.save();
  });
}

/* Wiring */
$$('#rec-toggle').addEventListener('click',toggleCollapse);
$$('#rec-toggle-btn').addEventListener('click',e=>{ e.stopPropagation(); toggleCollapse(); });

$$('#shop-toggle').addEventListener('click', toggleShopCollapse);
$$('#shop-toggle-btn').addEventListener('click', e=>{ e.stopPropagation(); toggleShopCollapse(); });
$$('#toggle-shop-only').addEventListener('click', e=>{ e.stopPropagation(); toggleShopOnly(); });

$$('#notes-toggle').addEventListener('click', toggleNotesCollapse);
$$('#notes-toggle-btn').addEventListener('click', e=>{ e.stopPropagation(); toggleNotesCollapse(); });

$$('#undo-top-btn').addEventListener('click', undoRemove);

/* Rec-UI */
$$('#rec-freq').addEventListener('change', ()=>{ setDaysEnabled($$('#rec-freq').value === 'weekly'); });
setDaysEnabled($$('#rec-freq').value === 'weekly');
$all('#rec-days .wbtn').forEach(btn=>{ btn.addEventListener('click', ()=> btn.classList.toggle('active')); });

$$('#rec-add').addEventListener('click',()=>{
  const title=($$('#rec-title').value||'').trim(); if(!title){ alert('Bitte Titel eingeben'); return; }
  const freq=$$('#rec-freq').value;
  const days = freq==='weekly' ? getSelectedWeekdays() : [];
  if(freq==='weekly' && days.length===0){ alert('Bitte mindestens einen Wochentag wählen.'); return; }
  addRec({title,freq,weekdays:days});
  $$('#rec-title').value=''; $all('#rec-days .wbtn.active').forEach(b=>b.classList.remove('active'));
});
$$('#rec-gen').addEventListener('click',()=>{ generateRecurring(true); render(); });

/* Shop add + Palette */
const shopInput=$$('#shop-input'); const shopAddBtn=$$('#shop-add');
if(shopInput && shopAddBtn){
  const add=()=>{ const v=(shopInput.value||'').trim(); if(!v) return; addShopItem(v); shopInput.value=''; shopInput.focus(); };
  shopAddBtn.addEventListener('click', add);
  shopInput.addEventListener('keydown', e=>{ if(e.key==='Enter') add(); });
}
const palInput=$$('#palette-input'); const palAddBtn=$$('#palette-add');
if(palInput && palAddBtn){
  const addFav=()=>{ const v=(palInput.value||'').trim(); if(!v) return; const name=v.trim(); if(!store.shopPalette.includes(name)){ store.shopPalette.push(name); store.save(); renderShop(); } palInput.value=''; palInput.focus(); };
  palAddBtn.addEventListener('click', addFav);
  palInput.addEventListener('keydown', e=>{ if(e.key==='Enter') addFav(); });
}

/* Init */
store.load();
wireAppTitle();
generateRecurring(true);
rolloverIfNeeded(true);
render();
applyNotesCollapseUI();
setInterval(()=>{ rolloverIfNeeded(false); generateRecurring(false); }, 30000);

if(store.tasks.length===0 && store.recs.length===0){
  addTask({title:'Beispiel Heute',column:'today'});
  addTask({title:'Beispiel Morgen',column:'tomorrow'});
  store.recs.push({id:uid(),title:'Pflanzen gießen',freq:'weekly',weekdays:[1,6]});
  store.save(); render();
}
    </script>
</body>
</html>
